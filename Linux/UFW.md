# UFW

## Настройка UFW Ubuntu

1. Синтаксис ufw

```bash
ufw опции действие параметры
```

2. Команды UFW

* `enable` - включить фаерволл и добавить его в автозагрузку;
* `disable` - отключить фаерволл и удалить его из автозагрузки;
* `reload` - перезагрузить файервол;
* `default` - задать политику по умолчанию, доступно allow, deny и reject, а также три вида трафика - incoming, outgoing или routed;
* `logging` - включить журналирование или изменить уровень подробности;
* `reset` - сбросить все настройки до состояния по умолчанию;
* `status` - посмотреть состояние фаервола;
* `show` - посмотреть один из отчётов о работе;
* `allow` - добавить разрешающее правило;
* `deny` - добавить запрещающее правило;
* `reject` - добавить отбрасывающее правило;
* `limit` - добавить лимитирующее правило;
* `delete` - удалить правило;
* `insert` - вставить правило.

3. Как включить UFW

```bash
sudo ufw status
```

Если он не включён, то его необходимо включить:

```bash
sudo ufw enable
```

Затем вы можете снова посмотреть состояние:

```bash
sudo ufw status
```

4. Политика по умолчанию

Все входящие пакеты будем отклонять:

```bash
sudo ufw default deny incoming
```

А все исходящие разрешим:

```bash
sudo ufw default allow outgoing
```

5. Добавление правил UFW

```bash
ufw allow имя_службы
```

```bash
ufw allow порт
```

```bash
ufw allow порт/протокол
```

Например, чтобы открыть порт ufw для SSH, можно добавить одно из этих правил:

```bash
sudo ufw allow OpenSSH
```

```bash
sudo ufw allow 22
```

```bash
sudo ufw allow 22/tcp
```

Посмотреть доступные имена приложений можно с помощью команды:

```bash
sudo ufw app list
```

Можно также указать направление следования трафика с помощью слов out для исходящего и in для входящего.

```bash
ufw allow направление порт
```

Например, разрешим только исходящий трафик на порт 80, а входящий запретим:

```bash
sudo ufw allow out 80/tcp
```

```bash
sudo ufw deny in 80/tcp
```

Также можно использовать более полный синтаксис добавления правил:

```bash
ufw allow proto протокол from ip_источника to ip_назначения port порт_назначения
```

В качестве ip_источника может использоваться также и адрес подсети. Например, разрешим доступ со всех IP-адресов для интерфейса eth0 по протоколу tcp к нашему IP-адресу и порту 3318:

```bash
sudo ufw allow proto tcp from 0.0.0.0/24 to 192.168.1.5 port 3318
```

6. Просмотр состояния UFW

```bash
sudo ufw status
```

Чтобы получить более подробную информацию, используйте параметр verbose:

```bash
sudo ufw status verbose
```

С помощью команды show можно посмотреть разные отчеты:

* `raw` - все активные правила в формате iptables;
* `builtins` - правила, добавленные по умолчанию;
* `before-rules` - правила, которые выполняются перед принятием пакета;
* `user-rules` - правила, добавленные пользователем;
* `after-rules` - правила, которые выполняются после принятия пакета;
* `logging-rules` - правила логгирования пакетов;
* `listening` - отображает все прослушиваемые порты и правила для них;
* `added` - недавно добавленные правила.

Например, посмотрим список всех правил iptables:

```bash
sudo ufw show raw
```

Посмотрим все прослушиваемые порты:

```bash
sudo ufw show listening
```

Или недавно добавленные правила:

```bash
sudo ufw show added
```

7. Удаление правил ufw

Чтобы удалить правило ufw, используется команда delete. Например, удалим ранее созданные правила для порта 80:

```bash
sudo ufw delete allow out 80/tcp
```

```bash
sudo ufw delete deny in 80/tcp
```

8. Логгирование в ufw

Чтобы отлаживать работу ufw, могут понадобится журналы работы брандмауэра. Для включения журналирования используется команда logging:

```bash
sudo ufw logging on
```

```bash
sudo ufw logging medium
```

Также этой командой можно изменить уровень логгирования:

* `low` - минимальный, только заблокированные пакеты;
* `medium` - средний, заблокированные и разрешённые пакеты;
* `high` - высокий.

Лог сохраняется в папке `/var/log/ufw`. Каждая строчка лога имеет такой синтаксис:

```
[UFW действие] IN=интерфейс OUT=итерфейс SRC=ip_источника DST=ip_назначения LEN=размер_пакета TOS=0x10 PREC=0x00 TTL=64 ID=728 DF PROTO=протокол SPT=порт_источника DPT=порт назначения LEN=размер_пакета
```

9. Отключение UFW

Если вы хотите полностью отключить UFW, для этого достаточно использовать команду disable:

```bash
sudo ufw disable
```

Также, если вы что-то испортили в настройках и не знаете как исправить, можно использовать команду reset для сброса настроек до состояния по умолчанию:

```bash
sudo ufw reset
```